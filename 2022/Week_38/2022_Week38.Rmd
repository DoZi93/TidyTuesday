---
title: "R Notebook"
output: html_notebook
---

# Load necessities
```{r}
library(tidyverse)
library(naniar)
library(showtext)
```

```{r}
WWTP.data <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-09-20/HydroWASTE_v10.csv")
```
# Load a list of continents and countries
```{r}
Continents.countries.list <- read_csv("https://raw.githubusercontent.com/dbouquin/IS_608/master/NanosatDB_munging/Countries-Continents.csv") %>%
  mutate(Country = case_when(Country == "CZ" ~ "Czech Republic",
                               Country == "Russian Federation" ~ "Russia",
                               Country == "US" ~ "United States",
                             TRUE ~ Country)) # all other values remain the same
```
# Add font
```{r}
font_add_google("Montserrat")
font_headlines <- "Montserrat"
font_add_google("Cousine")
font_text <- "Cousine"

showtext_auto()
```


# Inspect data
```{r}
print(colnames(WWTP.data))
tibble(WWTP.data)
```

```{r}
naniar::vis_miss(WWTP.data, warn_large_data = F)
```

```{r}
Countries.morethan.100.wwtp <- WWTP.data %>%
  group_by(COUNTRY) %>%
  count() %>%
  filter(n > 100) %>%
  select(COUNTRY)

WWTP.data.filtered <- WWTP.data %>%
  filter(COUNTRY %in% Countries.morethan.100.wwtp$COUNTRY &
           STATUS != "Closed" &
           POP_SERVED != 0) %>%
  left_join(Continents.countries.list, by = c("COUNTRY" = "Country")) %>%
  mutate(DischargePerPerson = WASTE_DIS/POP_SERVED) %>%
  group_by(COUNTRY) %>%
  mutate(DischargePerCountry = mean(DischargePerPerson)) %>%
  group_by(Continent) %>%
  mutate(DischargePerContinent = mean(DischargePerPerson)) %>%
  ungroup() %>%
  distinct(DischargePerCountry, .keep_all = T) %>%
  mutate(DischargePerPersonDiff = DischargePerContinent - DischargePerCountry) %>%
  arrange(DischargePerPersonDiff) %>%
  .[c(1:5, (dim(.)[1]-4):(dim(.)[1])),] %>%
  select(c("COUNTRY", "Continent", "DischargePerCountry":"DischargePerContinent")) %>%
  pivot_longer(cols = c(DischargePerContinent, DischargePerCountry)) %>%
  rename("Scale" = "name",
         "DischargePerPerson" = "value") %>%
  mutate(Scale = case_when(Scale == "DischargePerCountry" ~ "Country",
                           Scale == "DischargePerContinent" ~ "Continent"))
  
WWTP.data.filtered$COUNTRY <- factor(WWTP.data.filtered$COUNTRY, 
                                     levels = c("South Africa",
                                                         "Canada",
                                                         "India",
                                                         "Ireland",
                                                         "Romania",
                                                         "Turkey",
                                                         "Iran",
                                                         "Mexico",
                                                         "Egypt",
                                                         "Algeria"
                                                         ))

Continent <- WWTP.data.filtered %>%
  filter(Scale == "Continent")

Country <- WWTP.data.filtered %>%
  filter(Scale == "Country")
```


```{r}
dumbbell.DischargeDiff.Country.Continent <- ggplot(data = WWTP.data.filtered) +
  geom_rect(xmin = min(WWTP.data.filtered$DischargePerPerson),
            xmax = 8,
            ymin = -Inf,
            ymax = 5.5,
            fill = "#D57E7E",
            alpha = 0.009) +
  geom_rect(xmin = min(WWTP.data.filtered$DischargePerPerson),
            xmax = 8,
            ymin = 5.5,
            ymax = Inf,
            fill = "#CEE5D0",
            alpha = 0.025) +
  geom_segment(aes(x = DischargePerPerson,
                   y = COUNTRY,
                   xend = Country$DischargePerPerson,
                   yend = Country$COUNTRY),
              # linetype = "dotted",
               alpha = .1,
              size = 2,
               data = Continent) +
  geom_point(aes(x = DischargePerPerson, y = COUNTRY, shape = Scale),
             size = 2.3,
             fill = "#6495ed",
             color = "black") +
  scale_shape_manual(values = c(22,21)) +
  theme_minimal() +
  ylab("") +
  xlab("\nDischarge per Person") +
  theme(text = element_text(size = 9, family = font_headlines,
                            color = "#000000"),
        legend.position = "top",
        legend.justification = "left",
        legend.direction = "horizontal",
        axis.text = element_text(size = 12),
        axis.title.x = element_text (size = 13),
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        legend.key.size = unit(2, "line"),
        plot.margin = margin(0,0,0,1.7, "cm"),
        plot.background = element_rect(fill = "#E0EAEC",
                                       color = "#E0EAEC"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_line(color = "grey70",
                                          size=0.1,
                                          linetype = "dashed")) +
  guides(shape = guide_legend(override.aes = list(size = 2.4)))

plot(dumbbell.DischargeDiff.Country.Continent)
```

